name: "æ›´æ–°æ’ä»¶ç‰ˆæœ¬"

on:
  schedule:
    - cron: "0 1 * * 3"
  workflow_dispatch:

jobs:
  update-plugin-version:
    name: "æ›´æ–°æ’ä»¶ç‰ˆæœ¬"
    runs-on: ubuntu-latest
    steps:
      - name: "æ‹‰å–ä»£ç "
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: "é…ç½®ç¯å¢ƒ"
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.5"
          tools: composer

      - name: "è·å–æ—¥æœŸ"
        run: echo "CURRENT_DATE=$(TZ=Asia/Shanghai date +'%Y.%m.%d')" >> $GITHUB_ENV

      - name: "è·å–æ›´æ–°å‰ä¾èµ–ç‰ˆæœ¬"
        run: echo "AWS_SDK_VERSION_BEFORE=$(composer show aws/aws-sdk-php | grep versions | awk '{print $NF}')" >> $GITHUB_ENV

      - name: "æ›´æ–°ä¾èµ–"
        run: |
          composer install
          composer update
          sed -i "s/Version: .*/Version: ${{ env.CURRENT_DATE }}/" kratos-plugin-aws.php

      - name: "è·å–æ›´æ–°åä¾èµ–ç‰ˆæœ¬"
        run: echo "AWS_SDK_VERSION_AFTER=$(composer show aws/aws-sdk-php | grep versions | awk '{print $NF}')" >> $GITHUB_ENV

      - name: "åˆ¤æ–­æ˜¯å¦éœ€è¦å‘ç‰ˆ"
        id: check_change
        run: |
          if [ "$AWS_SDK_VERSION_BEFORE" = "$AWS_SDK_VERSION_AFTER" ]; then
            echo "SHOULD_RELEASE=false" >> $GITHUB_ENV
            echo "ç‰ˆæœ¬æœªå˜åŒ–ï¼Œè·³è¿‡å‘å¸ƒã€‚"
          else
            echo "SHOULD_RELEASE=true" >> $GITHUB_ENV
            echo "æ£€æµ‹åˆ°ç‰ˆæœ¬å˜åŒ–ï¼š$AWS_SDK_VERSION_BEFORE -> $AWS_SDK_VERSION_AFTER"
          fi

      - name: "æäº¤å¹¶æ¨é€å˜æ›´"
        if: env.SHOULD_RELEASE == 'true'
        uses: actions-js/push@v1.5
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          author_email: "41898282+github-actions[bot]@users.noreply.github.com"
          author_name: "github-actions[bot]"
          coauthor_email: "hi@seatonjiang.com"
          coauthor_name: "Seaton Jiang"
          message: "feat: æ›´æ–°æ’ä»¶ä¾èµ–ç‰ˆæœ¬"

      - name: "ç”Ÿæˆå˜æ›´æ—¥å¿—"
        if: env.SHOULD_RELEASE == 'true'
        run: |
          echo "### å˜æ›´æ—¥å¿—" >> ${{ github.workspace }}-CHANGELOG.txt
          echo "- ğŸš€ å‡çº§ä¾èµ–åŒ… \`aws/aws-sdk-php\` çš„ç‰ˆæœ¬åˆ° \`${{ env.AWS_SDK_VERSION_AFTER }}\`" >> ${{ github.workspace }}-CHANGELOG.txt
          echo "- âœ¨ å‡çº§æ’ä»¶ç‰ˆæœ¬åˆ° \`${{ env.CURRENT_DATE }}\`" >> ${{ github.workspace }}-CHANGELOG.txt

      - name: "æ•´ç†å‘å¸ƒæ–‡ä»¶"
        if: env.SHOULD_RELEASE == 'true'
        run: |
          mkdir -p dist/kratos-plugin-aws/{.github/assets,includes}
          cp .github/assets/wechat-reward.png dist/kratos-plugin-aws/.github/assets/
          cp kratos-plugin-aws.php includes/kratos-update-checker.php dist/kratos-plugin-aws/
          cp LICENSE dist/kratos-plugin-aws/
          rsync -a vendor/ dist/kratos-plugin-aws/vendor/ --exclude 'bin/*' --delete

      - name: "åˆ›å»ºæ’ä»¶å®‰è£…åŒ…"
        if: env.SHOULD_RELEASE == 'true'
        run: cd dist && zip -rq kratos-plugin-aws.zip kratos-plugin-aws -x ".*" "*.zip"

      - name: "åˆ›å»º Release"
        if: env.SHOULD_RELEASE == 'true'
        uses: softprops/action-gh-release@v2
        with:
          body_path: ${{ github.workspace }}-CHANGELOG.txt
          name: ${{ env.CURRENT_DATE }}
          tag_name: ${{ env.CURRENT_DATE }}
          token: ${{ secrets.GITHUB_TOKEN }}
          files: dist/kratos-plugin-aws.zip

      - name: "ä¸Šä¼ èµ„æºåˆ°å¤šå‰äº‘å­˜å‚¨"
        if: env.SHOULD_RELEASE == 'true'
        uses: seatonjiang/dogecloud-oss-action@main
        with:
          access_key: ${{ secrets.DOGECLOUD_ACCESS_KEY }}
          secret_key: ${{ secrets.DOGECLOUD_SECRET_KEY }}
          bucket: ${{ secrets.DOGECLOUD_BUCKET }}
          local_path: dist/kratos-plugin-aws.zip
          remote_path: kratos/plugin

      - name: "åˆ·æ–°å¤šå‰äº‘ CDN ç¼“å­˜"
        if: env.SHOULD_RELEASE == 'true'
        uses: seatonjiang/dogecloud-cdn-action@main
        with:
          access_key: ${{ secrets.DOGECLOUD_ACCESS_KEY }}
          secret_key: ${{ secrets.DOGECLOUD_SECRET_KEY }}
          type: "url"
          urls: "https://dl.seatonjiang.com/kratos/plugin/kratos-plugin-aws.zip"

      - name: "åˆ é™¤æ—§çš„ Release å’Œ Actions"
        if: env.SHOULD_RELEASE == 'true'
        uses: ophub/delete-releases-workflows@main
        with:
          delete_releases: true
          releases_keep_latest: 1
          delete_workflows: true
          workflows_keep_day: 1
          delete_tags: true
          gh_token: ${{ secrets.GITHUB_TOKEN }}
